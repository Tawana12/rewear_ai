{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-6 py-12">
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold italic tracking-tighter mb-4">Nearby Impact</h1>
        <p class="text-gray-500">Scanning for centers in your 15km radius using global data.</p>
        <button onclick="getLocation()" id="scan-btn" class="mt-8 bg-black text-white px-10 py-4 rounded-full text-xs font-bold uppercase tracking-widest hover:opacity-80 transition-opacity active:scale-95 shadow-xl shadow-black/10">
            üìç Scan My Radius
        </button>
    </div>

    <div id="results-grid" class="grid gap-4">
        <div class="text-center py-20 text-gray-300 italic border-2 border-dashed border-gray-100 rounded-3xl">
            Click scan to see donation spots near you.
        </div>
    </div>
</div>

<script>
function getLocation() {
    const btn = document.getElementById('scan-btn');
    const grid = document.getElementById('results-grid');
    
    btn.innerText = "Scanning Area...";
    grid.innerHTML = `<div class="text-center py-20 animate-pulse text-gray-400 font-bold uppercase tracking-widest text-[10px]">Connecting to Global Charity Database...</div>`;
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            fetch(`/donate/api/nearby?lat=${lat}&lon=${lon}`)
                .then(res => res.json())
                .then(data => {
                    renderCharities(data);
                    btn.innerText = "Scan Complete";
                    btn.classList.add('bg-green-600');
                })
                .catch(err => {
                    console.error(err);
                    btn.innerText = "Scan Failed";
                    grid.innerHTML = `<p class="text-center py-10 text-red-400 text-xs font-bold uppercase">Connection Error. Please check your internet.</p>`;
                });
        }, () => {
            btn.innerText = "Location Access Denied";
            grid.innerHTML = `<p class="text-center py-10 text-yellow-600 text-xs font-bold uppercase">Please enable location permissions in your browser.</p>`;
        });
    }
}

function renderCharities(charities) {
    const grid = document.getElementById('results-grid');
    if (charities.length === 0) {
        grid.innerHTML = "<p class='text-center py-10 text-gray-400 text-xs font-bold uppercase tracking-widest'>No registered centers found in this radius.</p>";
        return;
    }
    
    grid.innerHTML = charities.map(c => `
        <div class="p-8 bg-white border border-gray-100 rounded-3xl flex flex-col md:flex-row justify-between items-center hover:border-black hover:shadow-2xl hover:shadow-black/5 transition-all gap-6 group">
            <div class="text-center md:text-left">
                <p class="text-[9px] text-blue-600 uppercase tracking-widest font-black mb-1">${c.type}</p>
                <h3 class="font-bold text-xl tracking-tight">${c.name}</h3>
                <p class="text-xs text-gray-400 mt-1">${c.address || 'Local Area'}</p>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <a href="https://www.google.com/maps?q=${c.lat},${c.lon}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="bg-gray-50 px-6 py-3 rounded-full text-[10px] font-bold uppercase tracking-widest hover:bg-gray-200 transition-all whitespace-nowrap text-center">
                    üó∫Ô∏è View Map
                </a>
                
                <form action="/donate/log/{{ item_id if item_id else 0 }}" method="POST">
                    <input type="hidden" name="charity_name" value="${c.name}">
                    <button type="submit" class="bg-black text-white px-6 py-3 rounded-full text-[10px] font-bold uppercase tracking-widest hover:bg-blue-600 transition-all whitespace-nowrap">
                        ü§ù Log Donation
                    </button>
                </form>
            </div>
        </div>
    `).join('');
}
</script>
{% endblock %}